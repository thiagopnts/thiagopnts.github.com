<!DOCTYPE>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Patterns of Enterprise Application Architecture - Mapping to Relational Databases</title>
  <meta name="author" content="Thiago Pontes" />
  <meta name="description" content="Programming, Javascript, Ruby, Ruby on Rails, Scala, Python" />
  <meta property="fb:admins" content="thiagopnts"/>
  <link rel="openid.server" href="http://www.clickpass.com/openid_server" />
  <link rel="stylesheet" href="/css/compiled/base.css" type="text/css" media="screen, projection" />
  <link rel="stylesheet" href="/css/plugins/pygments.css" type="text/css" />
  <link media="only screen and (max-device-width: 480px)" href="/css/iphone.css" type="text/css" rel="stylesheet" />
  <link media="only screen and (device-width: 768px)" href="/css/ipad.css" type="text/css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="/js/compiled/application.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      
    });
  </script>
</head>

<body>
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/pt_BR/all.js#xfbml=1&appId=254582621301698";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>
    
  <section class="sidebar">
    <a href="/">
      <img src="http://www.gravatar.com/avatar/dfdcc7fdb4b631ae9c30acd5ac6c2cbe.png" height="75" width="75" class="avatar" />
    </a>

    <section class="name">
      <a href="/">
        <span id="thiago">Thiago</span>
        <span id="pontes">Pontes</span>
      </a>
    </section>

    <section class="alt-text">&nbsp;</section>

    <section class="meta">
      <a href="https://github.com/thiagopnts" id="github">
        <img src="/images/github.png" alt="github" title="thiagopnts on GitHub" height="16" width="16" />
      </a>
      <a href="https://twitter.com/thiagopnts" id="twitter">
        <img src="/images/twitter.png" alt="twitter" title="@thiagopnts on Twitter" height="16" width="16" />
      </a>
      <a href="http://feeds.feedburner.com/thiagopontes/lXRA" id="rss">
        <img src="/images/rss.png" alt="rss" title="Subscribe to this blog's RSS feed" height="16" width="16" />
      </a>
      
    </section>

  </section>

  <section class="content">
  <h1>
    <a href="/posts/enterprise-patterns-part3">Patterns of Enterprise Application Architecture - Mapping to Relational Databases</a>
  </h1>

  <section class="byline">
    April 11, 2012
  </section>

  <p><img src="http://ecx.images-amazon.com/images/I/511D6FdsbXL._AA160_.jpg" width="250" height="250" /></p>

<h2>Chapter 3 &ndash; Mapping to Relational Databases</h2>

<p>I particularly liked this chapter more then others, not because of the patterns described in this section(there is a lot of them) but how it describes the how and why there are some problems with creating/using an ORM, while reading this chapter you can identify several patterns cited through the text and think like &lsquo;wow, the way hibernate/activerecord/blah approachs data manipulation is a pattern called X&rsquo; and see the work arounds it does to deal with common object oriented practices like inheritance that mess up and are unviable to simulate/map in relational databases due normalization. This chapter also gave me a more deep view about relational databases, since my experience is most with the nosql ones, since I always have avoided sql and its third party functions(which I always forget) as much as I can. So for this chapter I will focus on the problems(and its alternatives) for this layer.</p>

<h2>The Behavioral Problem</h2>

<p>When we think in OR mapping the first thing that comes to mind is how the classes are mapped to tables and how to relate it. If you load several objects in the memory and modify them you hae to keep track of which ones you have modified and make sure to write all of them back out to the database, this gets more and more harder when dealing with several objects, as you read and modify them you have to ensure that the database state you&rsquo;re working stays consistent, so if the object X is already in memory you can&rsquo;t pull out the same row again and modify it. The pattern used to solve this problem is called &lsquo;Unit of Work&rsquo;. It keeps track of all objects read from the database together, it also handles how updates are made to the database, instead of the programmer call some save method it tells the unit of work to commit the changes(it remember me hibernate). This pattern also takes care about the problem of loading the same row twice, each time you read some data, you check if this data are already in the memory, to help with this task there is another pattern called &lsquo;Identity Map&rsquo;, it&rsquo;s to ensure the uniqueness from data in memory and should not be used as cache or to improve performance, but this approach leads to other problem, in the OOP it&rsquo;s normal to have have several objects which interacts with others, this interaction can be called object graph and as the models complexity grows the graph grows as well and when you try to pull this from the database what comes to you is a bunch of joined tables, which can turn in a bottle neck in the system, so there is another approach when it becomes a problem: The Lazy Load pattern. It is a object that doesn&rsquo;t have all the data, but knows how to get it if you need just keeping references, it acts like a pointer, so it avoid loading unnecessary data in the memory.</p>

<h2>Mapping Relationships</h2>

<p>The biggest problem here is how objects and relations handle links, which lead to two problems, the first is that there is a difference in representation, objects handle links by storing references that are held by, for instance, memory addresses, but relational databases handle links by forming a key in another table. The second problem is that objects can easily use collections to handle multiple references from a single field, while normalization forces all relation links to be single valued, this leads to reversals of the data structure between objects and tables. If an object has a collection, you need a query to find all the rows that link to the id of the object and it gets worse when you have to add or remove from collections. The pattern used for inter-object references is the &lsquo;Identity Field&rsquo;, which is simply keep the row&rsquo;s primary key as an attribute in the object, so you can easily access it&rsquo;s row.</p>

<h2>Inheritance</h2>

<p>This is another kind of hierarchy scheme that causes relational databases headaches, since there is no standard way to do inheritance in SQL this kind of relationship needs to be mapped too. For any inheritance structure there are basically three options. You can have one table for all the classes(Single Table Inheritance pattern), one table for each concrete class(Concrete Table Inheritance pattern), or one table per class in the inheritance hierarchy(Class Table Inheritance pattern). The trade-offs of this approachs are all related to data duplication and speed of access. In the first case the biggest downside is the wasted space, since each row has to have columns for all possible subtypes and this leads to empty columns. The second one avoids the joins allowing you to pull an object from one table, but if one super class changes you have to remember to update all the other tables which inherits from it. The third one is the simplest solution, but it needs multiple joins to load a single object, and too many joins reduces performance. There is no best solution here, you have to analyze your situation and pick the best fit.</p>

<p>I still want to talk about Metadata, DB Connections and other interesting points from this chapter, so I will split this post in two and talk about this in the next one.</p>


  <section class="meta">
    <h3>Discussion, links, and tweets</h3>
    <section class="copy">
      <a href="https://twitter.com/thiagopnts">
        <img src="http://www.gravatar.com/avatar/dfdcc7fdb4b631ae9c30acd5ac6c2cbe.png" height="80" width="80" />
      </a>

      <p>
          I'm a Software Engineer Intern which among one line of code and a cup of coffee likes to listen to music and disagree with people. </br>
          Feel free to send me a <a href="mailto:thiagopnts@gmail.com">email</a>. </br>
          I'm <a href="https://twitter.com/thiagopnts">@thiagopnts</a> on Twitter. </br>
          I'm <a href="http://git.io/thi">thiagopnts</a> on Github. </br>
          You can find me on <a href="http://facebook.com/thiagopnts">Facebook</a> and <a href="http://www.linkedin.com/profile/view?id=82767657">Linkedin</a>.
      </p>
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="true" data-via="thiagopnts">Tweet</a>
      <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
      <a href="http://twitter.com/thiagopnts" class="twitter-follow-button" data-show-count="false">Follow @thiagopnts</a>
      <script src="http://platform.twitter.com/widgets.js" type="text/javascript"></script>
      <div class="fb-like" data-href="http://thiagopontes.net/posts/enterprise-patterns-part3" data-send="false" data-width="450" data-show-faces="true"></div>    
      <div class="fb-comments" data-href="http://thiagopontes.net/posts/enterprise-patterns-part3" data-num-posts="5" data-width="500"></div>    
    </section>
  </section>
</section>


    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-18026195-3']);
      _gaq.push(['_setDomainName', 'thiagopontes.net']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
</body>

</html>
